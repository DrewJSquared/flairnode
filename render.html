<!DOCTYPE html>
<html>
<head>
	<title>Flair Node</title>
	<style>
		html, body {
			margin: 0;
			padding: 0;
			width: 1920px;
			height: 1080px;
			background: black;
			overflow: hidden;
			font-family: sans-serif;
		}

		#bootScreen, #errorScreen {
			position: absolute;
			top: 0; left: 0;
			width: 100%; height: 100%;
			display: flex;
			justify-content: center;
			align-items: center;
			background-color: black;
			z-index: 1000;
		}

		#bootScreen img, #errorScreen img {
			width: 100%;
			height: 100%;
			object-fit: contain;
		}
	</style>
</head>
<body>
	<!-- Boot splash -->
	<div id="bootScreen" style="display: none;">
		<img src="./Flair_Boot_128x128.png" alt="Flair Boot">
	</div>

	<!-- Error fallback -->
	<div id="errorScreen" style="display: none;">
		<img src="./Flair_Error_128x128.png" alt="Error">
	</div>

	<script>
		console.log('Welcome to the Flair REnder');

		const WS_PORT = 9223;
		const KEEPALIVE_TIMEOUT_MS = 15000; // time without message before error (15s)
		let ws;
		let lastMessageTime = Date.now();


		// DOM elements
		const bootScreen = document.getElementById('bootScreen');
		const errorScreen = document.getElementById('errorScreen');


		// === Boot sequence (1 s per color, fully crash-safe) ===
		function startBootSequence() {
			const colors = ['red', 'green', 'blue', 'black'];

			colors.forEach((color, idx) => {
				setTimeout(() => {
					try {
						document.body.style.backgroundColor = color;
						console.log('Flair boot color test ' + color);
					} catch (err) {
						console.error('Boot sequence error:', err);
						showErrorScreen();
					}
				}, idx * 1000); // 1000 ms per color
			});
		}

		// start boot pattern immediately
		startBootSequence();

		// show boot screen after 4 sec
		setTimeout(showBootScreen, 4000);


		// === WebSocket Setup ===
		function connectWebSocket() {
			try {
				ws = new WebSocket(`ws://localhost:${WS_PORT}`);

				ws.onopen = () => {
					console.log('WebSocket connected to backend.');
					hideErrorScreen();
				};

				ws.onmessage = (event) => {
					lastMessageTime = Date.now();

					try {
						const msg = JSON.parse(event.data);
						handleCommand(msg.command, msg.data);
					} catch (e) {
						console.error('Invalid message:', event.data);
					}
				};

				ws.onclose = () => {
					console.warn('WebSocket closed.');
					showErrorScreen();
				};

				ws.onerror = (err) => {
					console.error('WebSocket error:', err);
					showErrorScreen();
				};
			} catch (err) {
				console.error('WebSocket init error:', err);
				showErrorScreen();
				return;
			}
		}

		// connect web socket after 14 sec (4 sec RGB test 10 sec boot screen)
		setTimeout(connectWebSocket, 14000);


		// === Global crash guard ===
		window.addEventListener('error', (e) => {
			console.error('Unhandled error:', e.error || e.message);
			showErrorScreen();
		});

		window.addEventListener('unhandledrejection', (e) => {
			console.error('Unhandled promise rejection:', e.reason);
			showErrorScreen();
		});


		// handle websocket commands
		function handleCommand(command, data) {
			// On first valid command, hide boot screen
			bootScreen.style.display = 'none';

			switch (command) {
				case 'play_video':
					// TODO: Implement play logic
					break;

				case 'stop_video':
					// TODO: Implement stop logic
					break;

				case 'draw_layout':
					// TODO: Implement layout drawing
					break;

				case 'set_message':
					// TODO: Implement message overlay
					break;

				case 'fade_black':
					// TODO: Implement screen fade to black
					break;

				default:
					console.warn(`Unknown command: ${command}`);
			}
		}

		// === Fallback/Error Handling ===
		function showBootScreen() {
			console.log('Showing Flair boot screen...');
			bootScreen.style.display = 'flex';
		}

		function hideBootScreen() {
			bootScreen.style.display = 'none';
		}

		function showErrorScreen() {
			errorScreen.style.display = 'flex';
		}

		function hideErrorScreen() {
			errorScreen.style.display = 'none';
		}

		// === Keepalive Monitor ===
		setInterval(() => {
			if (Date.now() - lastMessageTime > KEEPALIVE_TIMEOUT_MS) {
				console.warn('No keepalive from backend. Showing error.');
				showErrorScreen();
			}
		}, 2000);
	</script>
</body>
</html>
