<!DOCTYPE html>
<html>
<head>
	<title>Flair Node</title>
	<style>
		html, body {
			margin: 0;
			padding: 0;
			width: 1920px;
			height: 1080px;
			background: black;
			overflow: hidden;
			font-family: sans-serif;
		}

		#bootScreen, #errorScreen {
			position: absolute;
			top: 0; left: 0;
			width: 100%; height: 100%;
			display: flex;
			justify-content: center;
			align-items: center;
			background-color: black;
			z-index: 1000;
		}

		#bootScreen img, #errorScreen img {
			width: 100%;
			height: 100%;
			object-fit: contain;
		}
	</style>
</head>
<body>
	<!-- Boot splash -->
	<div id="bootScreen">

		<!-- <img src="file:///Users/drewshipps/NodeJS/flairnode/Flair_Boot_128x128.png" alt="Flair Boot"> -->
		<img src="./Flair_Boot_128x128.png" alt="Flair Boot">
	</div>

	<!-- Error fallback -->
	<div id="errorScreen" style="display: none;">
		<img src="./Flair_Error_128x128.png" alt="Error">
	</div>

	<script>
		const WS_PORT = 9223;
		const KEEPALIVE_TIMEOUT_MS = 10000; // time without message before error
		let ws;
		let lastMessageTime = Date.now();

		// DOM elements
		const bootScreen = document.getElementById('bootScreen');
		const errorScreen = document.getElementById('errorScreen');

		// RGB test pattern
		setTimeout(() => document.body.style.backgroundColor = 'red', 0);
		setTimeout(() => document.body.style.backgroundColor = 'green', 1000);
		setTimeout(() => document.body.style.backgroundColor = 'blue', 2000);
		setTimeout(() => document.body.style.backgroundColor = 'black', 3000);

		// === WebSocket Setup ===
		function connectWebSocket() {
			ws = new WebSocket(`ws://localhost:${WS_PORT}`);

			ws.onopen = () => {
				console.log('WebSocket connected to backend.');
				hideErrorScreen();
			};

			ws.onmessage = (event) => {
				lastMessageTime = Date.now();

				try {
					const msg = JSON.parse(event.data);
					handleCommand(msg.command, msg.data);
				} catch (e) {
					console.error('Invalid message:', event.data);
				}
			};

			ws.onclose = () => {
				console.warn('WebSocket closed.');
				showErrorScreen();
			};

			ws.onerror = (err) => {
				console.error('WebSocket error:', err);
				showErrorScreen();
			};
		}

		function handleCommand(command, data) {
			// On first valid command, hide boot screen
			bootScreen.style.display = 'none';

			switch (command) {
				case 'play_video':
					// TODO: Implement play logic
					break;

				case 'stop_video':
					// TODO: Implement stop logic
					break;

				case 'draw_layout':
					// TODO: Implement layout drawing
					break;

				case 'set_message':
					// TODO: Implement message overlay
					break;

				case 'fade_black':
					// TODO: Implement screen fade to black
					break;

				default:
					console.warn(`Unknown command: ${command}`);
			}
		}

		// === Fallback/Error Handling ===
		function showErrorScreen() {
			errorScreen.style.display = 'flex';
		}

		function hideErrorScreen() {
			errorScreen.style.display = 'none';
		}

		// === Keepalive Monitor ===
		setInterval(() => {
			if (Date.now() - lastMessageTime > KEEPALIVE_TIMEOUT_MS) {
				console.warn('No keepalive from backend. Showing error.');
				showErrorScreen();
			}
		}, 2000);

		// Start connection
		connectWebSocket();
	</script>
</body>
</html>
